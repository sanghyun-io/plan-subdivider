---
name: subdivide
description: 계획 파일을 세부 작업 파일로 분리. Plan 모드 완료 후 세부 계획 구조화에 사용.
invocation:
  command: subdivide
  user_invocable: true
  args:
    - name: plan_path
      description: 세분화할 계획 파일 경로 (생략 시 가장 최근 계획)
      required: false
---

# Plan Subdivide Skill

기존 계획 파일을 세부 작업 파일로 분리하는 스킬입니다.

---

## ⚠️ Plan 모드 체크 (최우선)

> **IMPORTANT**: Plan 모드라면 먼저 탈출 후 이 스킬을 실행하세요.

### Plan 모드 감지 시 행동

1. **ExitPlanMode 실행**: Plan 모드를 먼저 탈출
2. **그 다음 `/subdivide` 정상 실행**: 탈출 후 Step 1부터 진행

### 왜 Plan 모드 탈출이 필요한가?

- Plan 모드에서는 파일 생성(Write)이 계획 파일로 해석됨
- 계획 분석 과정에서 새로운 계획을 작성하려는 동작이 발생
- Plan 모드 탈출 후 정상적으로 세분화 작업 가능

---

## 사용법

```bash
/subdivide                           # 가장 최근 계획 파일 세분화
/subdivide ~/.claude/plans/my-plan.md  # 특정 계획 파일 세분화
```

---

## 실행 단계

### Step 0: Plan 모드 탈출

1. 현재 Plan 모드인지 확인
2. Plan 모드라면 `ExitPlanMode` 실행하여 탈출
3. 탈출 완료 후 Step 1로 진행

### Step 1: 계획 파일 확인

1. 인자로 경로가 제공되면 해당 파일 사용
2. **현재 대화 컨텍스트에서 Plan 파일 탐색**:
   - 컨텍스트에 Plan 내용(계획 제목, 파일 경로 등)이 있으면 해당 파일 사용
   - ExitPlanMode 직후라면 방금 작성한 계획 파일을 우선 사용
   - 컨텍스트에서 Plan 파일명을 추출할 수 없으면 다음 단계로
3. 위 두 경우 모두 해당 없으면 `~/.claude/plans/` 에서 가장 최근 수정된 `.md` 파일 선택
4. 이미 세분화된 계획(폴더 존재)이면 경고 후 확인 요청

### Step 2: 계획 분석

계획 파일을 읽고 다음을 추출:

1. **전체 목표**: 계획의 주요 목적
2. **작업 목록**: 수행해야 할 작업들
3. **의존성**: 작업 간 순서/의존성
4. **참조 섹션**: 원본 계획서 내 섹션 번호

분석 기준 (Rules 참조: @~/.claude/rules/plan-structure.md):
- 독립적 결과물 단위로 분리
- 논리적 순서 고려
- 검증 가능한 단위로 구성

### Step 3: 세부 작업 정의

추출된 정보를 바탕으로 세부 작업 정의:

```
작업 1: {작업명}
  - 목표: {목표}
  - 체크리스트: [{항목들}]
  - 참조: {원본 섹션}

작업 2: {작업명}
  ...
```

### Step 4: 사용자 확인

세분화 계획을 사용자에게 보여주고 **AskUserQuestion으로** 확인:

```
## 세분화 계획

원본: {계획 파일명}
세부 작업 수: {N}개

| 순서 | 작업명 | 설명 |
|:----:|--------|------|
| 1 | {작업1} | {설명1} |
| 2 | {작업2} | {설명2} |
...
```

그 다음 **반드시 AskUserQuestion 도구 사용**:

```json
{
  "questions": [{
    "question": "이대로 세분화를 진행하시겠습니까?",
    "header": "세분화 확인",
    "multiSelect": false,
    "options": [
      {
        "label": "진행",
        "description": "세분화 계획대로 파일 생성 시작 (Shift+Tab으로 일괄 허용 가능)"
      },
      {
        "label": "수정 필요",
        "description": "계획을 다시 검토하고 수정"
      },
      {
        "label": "취소",
        "description": "세분화 작업 중단"
      }
    ]
  }]
}
```

**⚠️ 중요**:
- 일반 텍스트로 "이대로 세분화를 진행할까요?"라고 물어보지 말 것
- 반드시 AskUserQuestion 도구를 사용하여 선택지 제공

### Step 5: 파일 생성

사용자 승인 후:

1. **폴더 생성**: `~/.claude/plans/{plan-name}/`
2. **세부 파일 생성**: `{순서2자리}-{작업명}.md`
3. **메인 파일 업데이트**: 목차 테이블 추가

> **⚠️ 중요**: Step 4에서 사용자가 승인하면, 모든 세부 파일을 **한 번에 생성**합니다.
> 각 파일마다 개별 확인을 요청하지 마세요.
> - 모든 Write 작업을 **단일 메시지에서 병렬로** 실행
> - 사용자에게 매 파일마다 확인을 요청하지 않음
> - Step 4의 승인이 전체 파일 생성에 대한 승인임

### Step 6: 완료 보고 및 다음 단계

완료 보고 후 **AskUserQuestion으로** 다음 단계 제안:

```
## 세분화 완료 ✅

{계획명}이 {N}개의 세부 작업으로 성공적으로 분리되었습니다.

생성된 파일:
- 메인 계획: ~/.claude/plans/{plan-name}.md
- 세부 작업: ~/.claude/plans/{plan-name}/01-{첫번째}.md ~ {N}-{마지막}.md
```

그 다음 **반드시 AskUserQuestion 도구 사용**:

```json
{
  "questions": [{
    "question": "다음 단계를 선택하세요",
    "header": "다음 단계",
    "multiSelect": false,
    "options": [
      {
        "label": "첫 번째 작업 시작",
        "description": "Task 01 파일을 열고 즉시 구현 시작"
      },
      {
        "label": "계획 전체 검토",
        "description": "메인 계획 파일과 모든 세부 작업 검토"
      },
      {
        "label": "나중에",
        "description": "지금은 파일만 생성하고 나중에 작업"
      }
    ]
  }]
}
```

**⚠️ 중요**:
- 일반 텍스트로 "작업을 시작하세요" 같은 지시만 하지 말 것
- 반드시 AskUserQuestion 도구를 사용하여 선택지 제공

---

## 세부 파일 템플릿

각 세부 파일은 다음 구조로 생성:

```markdown
# Task {순서}: {작업명}

> **순서**: {현재}/{전체}
> **이전 작업**: [{이전 작업명}](./{이전 파일}) 또는 (없음 - 시작 작업)
> **다음 작업**: [{다음 작업명}](./{다음 파일}) 또는 (없음 - 마지막 작업)
> **참조**: 원본 계획서 {섹션 참조}

---

## 목표

{원본 계획에서 추출한 이 작업의 목표}

---

## Checklist

### 1. {첫 번째 단계}

- [ ] {세부 작업 1}
- [ ] {세부 작업 2}

### 2. {두 번째 단계}

- [ ] {세부 작업 3}

---

## 완료 조건

1. 모든 Checklist 항목 체크 완료
2. 빌드 성공 (해당 시)
3. 테스트 통과 (해당 시)

---

## 검증 명령어

```bash
# 프로젝트 컨텍스트에 맞는 명령어 자동 감지
# Kotlin/Java: ./gradlew build 또는 ./gradlew ktlintCheck
# Node.js: npm test 또는 npm run lint
# Python: pytest 또는 ruff check
```

---

## 다음 작업 안내

검증 통과 후, 다음 작업으로 이동:

**[Task {다음}: {다음 작업명}](./{다음 파일})**

다음 작업에서는:
- {다음 작업 요약}

---

*생성일: {오늘 날짜}*
```

---

## 메인 파일 업데이트

메인 계획 파일 상단에 목차 테이블 추가:

```markdown
## 실행 계획 목차 (Implementation Tasks)

이 계획서는 {N}개의 세부 작업으로 분리되었습니다.

| 순서 | 작업명 | 파일 | 설명 |
|:----:|--------|------|------|
| 1 | **{작업1}** | [01-{파일명}.md](./{폴더}/01-{파일명}.md) | {설명} |
| 2 | **{작업2}** | [02-{파일명}.md](./{폴더}/02-{파일명}.md) | {설명} |
...

### 작업 규칙

1. **순차 실행**: Task 01부터 순서대로 진행
2. **체크리스트**: 각 작업의 모든 항목을 체크 후 다음으로 이동
3. **검증 실행**: 각 작업 완료 시 검증 명령어 실행
4. **링크 이동**: 작업 파일 하단의 "다음 작업" 링크로 이동

---
```

---

## 분리 기준 가이드

### 좋은 분리 예시

| 프로젝트 유형 | 분리 단위 |
|--------------|----------|
| 엔티티 추가 | Domain → Repository → Service → Controller → Test |
| API 개발 | 엔드포인트별 또는 CRUD 단위 |
| 리팩토링 | 모듈별 또는 계층별 |
| 마이그레이션 | 준비 → 실행 → 검증 → 정리 |
| 기능 추가 | 백엔드 → 프론트엔드 → 통합 테스트 |

### 분리하지 말아야 할 경우

- 5분 이내 완료 가능한 작업
- 단일 파일 수정
- 의존성이 너무 강해 분리 불가능한 작업

---

## 관련 규칙

- @~/.claude/rules/plan-structure.md - 계획 구조 규칙

---

## 예시

### 입력 (원본 계획)

```markdown
# User Authentication 구현

## 목표
JWT 기반 인증 시스템 구현

## 구현 내용
1. User 엔티티 생성
2. UserRepository 생성
3. AuthService 구현
4. AuthController API 작성
5. 테스트 작성
```

### 출력 (세분화 결과)

```
user-authentication/
├── 01-user-entity.md
├── 02-user-repository.md
├── 03-auth-service.md
├── 04-auth-controller.md
└── 05-integration-tests.md
```

---

*이 스킬은 Plan 모드 완료 후 계획을 구조화하는 데 사용됩니다.*
